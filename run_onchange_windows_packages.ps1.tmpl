{{ if eq .chezmoi.os "windows" -}}

# ----------------------------------------
# FILEHASH CHECK (in-memory only)
# ----------------------------------------
$packagesFile = "$HOME/.local/share/chezmoi/.chezmoidata/packages.yaml"

# Get SHA256 hash as a single string
$currentHash = (CertUtil -hashfile $packagesFile SHA256 | Select-String "^[0-9A-F]{2}" | ForEach-Object { $_.ToString().Trim() }) -join ''

Write-Host "Packages.yaml SHA256: $currentHash" -ForegroundColor Cyan

# ----------------------------------------
# ADMIN CHECK
# ----------------------------------------
$isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")
if (-not $isAdmin) {
    $input = Read-Host -Prompt "Install Packages? (y/n)"
    if ($input -eq 'n') {
        Write-Host "Skipping package installation." -ForegroundColor Yellow
        exit
    } else {
        # Relaunch as admin
        Start-Process -FilePath powershell -ArgumentList "-File", "$PSCommandPath" -Verb RunAs -Wait
        exit
    }
}

# ----------------------------------------
# BUILD PACKAGE LIST
# ----------------------------------------
$packages = @()
{{- $withWin := dict -}}
{{- range $key, $value := .packages -}}
    {{- if (index $value "win") -}}
        {{- $_ := set $withWin $key $value -}}
    {{- end -}}
{{- end -}}
{{- $keys := keys $withWin -}}
{{- range $i, $key := $keys }}
$packages += @{
    Name   = "{{$key}}"
    Script = @'
{{ index (index $withWin $key) "win" | replace "'" "''" }}
'@
}
{{- end }}

$totalPackages = $packages.Count
$currentPackage = 0

Write-Host ""
Write-Host "Processing $totalPackages Packages..." -ForegroundColor Cyan
Write-Host ""

# ----------------------------------------
# EXECUTE PACKAGES
# ----------------------------------------
foreach ($pkg in $packages) {
    # Refresh PATH from system + user in case previous installs modified it
    $env:Path = [System.Environment]::GetEnvironmentVariable('Path', [System.EnvironmentVariableTarget]::Machine) + ';' +
                [System.Environment]::GetEnvironmentVariable('Path', [System.EnvironmentVariableTarget]::User)

    $currentPackage++
    Write-Host "----- [$currentPackage/$totalPackages] $($pkg.Name) -----" -ForegroundColor Magenta

    # Optional: check for main binary before running
    try {
        Invoke-Expression $pkg.Script
    } catch {
        Write-Warning "Error installing $($pkg.Name): $_"
    }
}

Write-Host ""
Write-Host "Finished processing packages. Current packages.yaml hash: $currentHash" -ForegroundColor Green
Read-Host -Prompt "Press Enter to exit the package installer"

{{ end -}}
