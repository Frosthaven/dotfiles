{{ if eq .chezmoi.os "windows" -}}

# ----------------------------------------
# FILEHASH CHECK
# ----------------------------------------
$packagesFile = "$HOME/.local/share/chezmoi/.chezmoidata/packages.yaml"
$hashFilePath = "$HOME/.local/share/chezmoi/.chezmoidata/packages.hash"

# Get SHA256 hash as a single string
$currentHash = (CertUtil -hashfile $packagesFile SHA256 | Select-String "^[0-9A-F]{2}" | ForEach-Object { $_.ToString().Trim() }) -join ''

$hashChanged = $true
if (Test-Path $hashFilePath) {
    $previousHash = Get-Content $hashFilePath -Raw
    if ($previousHash -eq $currentHash) {
        $hashChanged = $false
    }
}

if (-not $hashChanged) {
    Write-Host "No changes in packages.yml; skipping package installation." -ForegroundColor Green
    exit
}

# Save the hash cleanly
$currentHash | Set-Content -Encoding ASCII $hashFilePath

# ----------------------------------------
# ADMIN CHECK
# ----------------------------------------
$isAdmin = ([Security.Principal.WindowsPrincipal] [Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole] "Administrator")
if (-not $isAdmin) {
    $input = Read-Host -Prompt "Install Packages? (y/n)"
    if ($input -eq 'n') {
        Write-Host "Skipping package installation." -ForegroundColor Yellow
        exit
    } else {
        # Relaunch as admin
        Start-Process -FilePath powershell -ArgumentList "-File", "$PSCommandPath" -Verb RunAs -Wait
        exit
    }
}

# ----------------------------------------
# BUILD PACKAGE LIST
# ----------------------------------------
$packages = @()
{{- $withWin := dict -}}
{{- range $key, $value := .packages -}}
    {{- if (index $value "win") -}}
        {{- $_ := set $withWin $key $value -}}
    {{- end -}}
{{- end -}}
{{- $keys := keys $withWin -}}
{{- range $i, $key := $keys }}
$packages += @{
    Name   = "{{$key}}"
    Script = @'
{{ index (index $withWin $key) "win" | replace "'" "''" }}
'@
}
{{- end }}

$totalPackages = $packages.Count
$currentPackage = 0

Write-Host ""
Write-Host "Processing $totalPackages Packages..." -ForegroundColor Cyan
Write-Host ""

# ----------------------------------------
# EXECUTE PACKAGES
# ----------------------------------------
foreach ($pkg in $packages) {
    # Refresh PATH from system + user in case previous installs modified it
    $env:Path = [System.Environment]::GetEnvironmentVariable('Path', [System.EnvironmentVariableTarget]::Machine) + ';' +
                [System.Environment]::GetEnvironmentVariable('Path', [System.EnvironmentVariableTarget]::User)

    $currentPackage++
    Write-Host "----- [$currentPackage/$totalPackages] $($pkg.Name) -----" -ForegroundColor Magenta
    Invoke-Expression $pkg.Script
}

# ----------------------------------------
# SAVE HASH AFTER INSTALL
# ----------------------------------------
$currentHash | Out-File -Encoding ASCII $hashFilePath

Write-Host ""
Read-Host -Prompt "Done! Press Enter to exit the package installer."

{{ end -}}
